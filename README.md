## 介绍
使用 SSH 框架写的一个小项目，主要功能就是用来展示古文书籍，这里只是完成一部分功能。虽然功能不是太多，但是涉及到了很多的技术，比较适合入门学习。

## 程序功能
+ 用户注册
    - 邮箱验证： Java Mail，随机用户激活码， Spring 线程池（ 邮件发送使用线程池中一个单独线程）
    - 用户名、邮箱唯一性（ ajax 检查）
    - Js + Struts2 双重检验（非空，长度，合法性）
    - 验证码
    - 用户名限制输入（不能输入中文或特殊字符）
    - 密码： MD5 加密
+ 用户登录
    - 自动登录：filter + cookie
    - Js + Struts2 双重检验
    - 验证码
+ 密码找回
    - 用户名合法性检测
    - 通过邮箱发送密码重置链接
+ 用户中心
    - 查看个人信息
    - 更改密码
    - 查看近期操作(通过日志实现)
    - 查看收藏（删除）
+ 管理中心(具有管理员权限)
    - 查看当前用户（ 删除用户，查看该用户近期操作）
    - 查看近期操作（所有用户）
+ 分页显示
    - 封装 Pager 类（包含查询结果，总记录数， 每页记录数， 总页数，当前页数，上一页，下一页，首页，尾页等信息）
+ 限制直接访问 jsp 文件
    - Filter（过滤所有 jsp 文件，重定向到 index.action）
+ 用户权限控制
    - Interceptor + 注解
+ 日志记录
    - Interceptor + 注解（同时有一个使用 Spring AOP 进行拦截的示例）
    - 自动删除 30 天之前的日志： Spring 定时器（程序中也有一个使用 Quartz 的示例）
+ 书籍查看
    - 分类检索
    - 搜索

## 具体实现
### 邮箱验证
用户注册成功后，系统会自动发送激活邮件到用户邮箱，用户点击激活链接，激活之后才能正常登录，否则会给出用户尚未激活的提示。发送邮件的功能是使用 java mail 进行实现的，原邮件地址为 sdu_doc@163.com，密码为 sdudoc。激活链接包括用户名以及随机产生的验证码，验证码产生规则为： username + 随机 double，然后再进行 MD5 加密。此验证码会保存到数据库表中，当用户点击链接后，会根据链接中的用户名和验证码检索数据库，如果发现数据库中存在对应记录，该用户的状态更改为已激活，用户激活成功。另外，这里用到了 Spring的线程池，因为发送邮件需要验证等一系列步骤，如果和 action 的逻辑代码在一个线程中可能造成 action 长时间不能返回，从而降低用户体验度。因此，这里将邮件的发送放到了一个单独的线程中，从而使 action 可以立即返回。如果没有成功发送邮件，用户可以选择重新发送邮件。 Spring 线程池配置以及具体用法可以查看 applicationContext.xml 以及 SendMailHelper.java。

### 用户名、邮箱唯一性验证
项目中设定用户名和其对应邮箱必须唯一，因此在注册时需要告诉用户用户名和邮箱是否可用（是否已经注册），这里主要使用 ajax进行异步验证，使用 jquery简化 ajax 调用， jquery 对 ajax 调用进行了封装，兼容多浏览器。同时对注册时用户名和邮箱输入框加入焦点事件，当失去焦点时就进行 ajax 检测，然后给出检查结果，如果不可使用，则将提交按钮设置为不可用，使用户无法提交表单。

### Js+Struts2 双重检测
在登录、注册等需要填写表单的网页中，我们需要检测输入的数据进行合法性检测，例如数据是否为空，用户名长度是否验证要求，两次密码输入是否一致，邮箱格式是否正确等等。一般我们会在客户端使用 js 进行检测，但是我们不排除个别用户将 js 删除，故意提交错误数据的可能性，因此在服务器端必须要进行相应检测。在服务器端我们使用 Struts2 进行检测。我们这里使用的是 xml 的检测方式， 如果数据不和要求就会返回到输入页面，并且给出错误提示。

### 验证码
验证码的实现主要依赖于 session。首先在服务器端生成验证码要显示的字符串（一般是随机数），然后将生成的字符串保存到 session 中，然后再根据验证码生成对应图片，传送到客户端。用户提交表单后，会首先比对传入的验证码和session 的是否一致，如果不一致，则返回输入页面。这里需要注意的是我们在使用 Struts2 显示验证码时，要配置 action 的属性，因为与一般的 action 不同，验证码的 action 需要返回图片。因此需要配置 action 的 type 为 stream。并提供一个 InputStream 类型的成员变量。